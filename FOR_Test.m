clear;clc
N =30;
CSI = [-1.95638241003991 - 2.75875587417837i,-1.20295223935440 - 0.925019754904654i,0.757657414399809 - 0.333313124564657i,0.266518698554429 - 3.23568982929846i;-1.47412699554298 - 2.55717626713365i,-1.35299924872413 - 0.394407372339494i,-0.226674372335354 + 0.317559690229727i,-0.432579752617695 - 5.02356353217503i;-0.340736962509885 - 1.91679674983923i,-0.140015381886961 - 0.306017033994209i,-0.838478227031428 - 0.102923728656798i,-3.01544339830878 - 0.191615332553850i;0.0226167225109457 - 0.0595825274128686i,-0.0424026226921987 - 2.28822119743645i,0.343251467645188 - 2.06170131123568i,1.80202757545554 + 6.88485083903753i;-0.910379416504157 + 1.40461705474549i,3.01583057369547 - 0.170367642851125i,-0.653953468856512 - 0.576512226371625i,0.889182131966889 - 1.48851886149869i;5.15381563973274 - 7.05388595311342i,4.46011366421879 + 0.455227022826166i,-0.387897114475722 + 0.678994549027960i,-0.0696111161183699 + 9.05017538090740i;-2.01342126940701 + 0.241457074380364i,-0.120241902932648 + 2.07579157080652i,0.871245462008944 + 0.0613024414767053i,-2.31108570278455 - 4.12290887645678i;2.92086217537267 - 4.74009405386347i,0.262095159366723 - 1.84388530198456i,0.00828330471868014 - 1.74949880022838i,4.06065929752779 + 3.30696225070131i;-0.0641000900026459 + 2.42079594113719i,3.38323827267001 - 1.74040939682518i,1.38948077740595 - 1.34734826313527i,1.01233870552541 - 0.132012322612569i;4.33898565745009 + 0.606196696273384i,5.70747527026433 + 2.74740522307418i,0.877696776036226 + 2.20038533981844i,2.94972067170261 + 0.520923957486233i;-3.77735889472875 - 1.10423512245389i,2.04990125089651 - 2.12388660417474i,-0.263152233023776 + 1.20676842862846i,2.47059314082366 + 1.88045714599915i;1.41985363646938 + 4.11087788887328i,-2.99000264293812 - 1.31834698399815i,1.98656909544657 - 0.619360954508489i,-2.59896403783023 - 0.786521372179641i;-0.789702776875434 - 0.251113649436877i,0.797773681976734 - 0.406940014268322i,-0.876262715866463 - 1.67744910590598i,-1.38850661417217 - 0.117733141664984i;-1.60942443776678 + 2.49249523787128i,0.528024177995934 + 0.465871159573921i,-1.38024584974989 - 0.641998726669600i,-2.36813548939727 + 0.375564161625705i;1.62556929265535 - 1.80332390296103i,1.20395145586265 + 0.152031552684517i,-0.375503913133541 + 0.335922596172536i,-0.376416265317246 - 2.13625698917687i;-1.94430622966060 + 0.364660875647452i,2.20526248752037 - 1.69787124984327i,1.25279762523316 + 0.255344267166103i,-1.10090997970094 - 0.681312211539857i;0.444761923830457 + 3.03649536119207i,1.33758225560465 - 1.40922247047682i,-0.572265459116787 + 0.0333595554945876i,-2.52783986143265 - 0.345304900921344i;1.32345157408583 - 1.92503087035023i,-1.49475980262979 + 0.941584274487234i,-0.00538790906117568 + 0.0838414574822397i,-0.812692966961560 - 0.329482032089892i;-0.401746656958598 - 2.99502764896455i,-1.56011114922753 - 0.483234245640045i,1.58866194655265 + 2.16897994680010i,-1.83414799210262 - 0.784694637567495i;-0.187552423609763 - 0.794805333529414i,2.90141493796125 - 1.04239901571549i,-0.296175469512301 + 0.349404359532018i,-0.967802638625862 + 0.459558077933622i;-1.05916514241392 + 2.62990461464677i,-0.127657166404264 + 1.27175794328213i,0.453355586575275 - 0.395242205621596i,1.00437545205263 - 0.113497711922510i;1.90395802716558 - 0.459675194787659i,1.31896988828430 + 3.12491389135858i,0.191303041276403 + 0.898628369544324i,-0.638066968099344 + 1.32287014051061i;0.221399802206465 + 0.961870413027769i,-0.793505327352952 - 0.887078872698162i,0.374736627924573 - 0.733292262558029i,-1.32189661208566 - 0.175775564424085i;1.03369569936841 - 0.360216251323112i,-0.524893335235561 + 0.175517548732398i,-0.323672553832358 - 0.233046895902401i,-1.36568456738834 - 0.275116882931810i;1.81910808502978 + 0.402356831995533i,-1.37359780688766 + 0.0848904234916934i,-0.662043196090628 - 0.641291182438621i,1.12820137453632 + 1.11631342039146i;0.716423943563815 + 1.49149571327518i,-2.04067108660441 + 1.15067272907239i,-1.29136146562718 - 0.181876161525646i,-0.0459254269988434 + 1.21333397038926i;-1.84663296374404 - 0.299228504819382i,-0.929757353381036 - 2.32289289513864i,1.22592918954826 - 0.440438260786925i,0.750248294762751 + 0.671544487976005i;7.16890231051922 + 1.96957705059203i,0.552268055122929 - 4.34421123909586i,2.59790685632973 - 0.0244149353864268i,-4.15451230944080 + 1.95689839011670i;1.11841362173248 - 0.567325603103407i,-0.588917584011345 + 0.598261056955580i,1.31276982011960 - 1.17033843185003i,-0.0542235561274338 + 0.375000183732927i;-2.09902356767411 - 1.69594275251480i,2.27235240089603 - 0.231298965349699i,0.0472748142838064 + 0.263477617399043i,2.48685013033923 + 1.77390206317883i];
M = 4;
orthogonal_set = zeros(N, M);
quantize_set = ones(1, N );
    for i = 1 : N
        orthogonal_set(i,M) = i;
        CSI_per_user = CSI(i,:);
        CSI_per_user_direction = CSI_per_user/norm(CSI_per_user);
        orthogonal__directions = null(CSI_per_user_direction);
        CSI_vectors = [orthogonal__directions,CSI_per_user_direction']; % orthogonol vectors for ith user

        inner_products = (abs (CSI*CSI_vectors) ).^2;
        norms_CSI = (diag (CSI*CSI') );
        norms_vectors = (diag (CSI_vectors'*CSI_vectors) );
        norms = norms_CSI* norms_vectors';
        metric_proximty_per_user(i,:,:) = inner_products./norms;
        %-------------find M-1 most orthogonal users with ith user
        for j = 1 : M-1
            orthogonal_set(i, j) = find(metric_proximty_per_user(i,:,j) == max(metric_proximty_per_user(i,:,j)), 1 );
            quantize_set(i) = quantize_set(i) + max(metric_proximty_per_user(i,:,j));
        end
    end
    
    max_index  = find( quantize_set == max(quantize_set), 1 );
    
    selected_user = orthogonal_set(max_index,:);
    
%     metric_proximty = squeeze (mean(metric_proximty_per_user,1));
%     
%     if size(metric_proximty,2) == 1
%         metric_proximty = metric_proximty';
%     end

