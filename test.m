clear;clc

pkt_num = 20;
ant_num = 4;
CSI = [-0.301225891433233 - 0.242776834414418i,0.582686913203829 + 1.80349920907531i,0.125016485188891 - 1.11834221864497i,1.18053698111464 - 1.47119524253167i;1.14016782422772 - 1.41962232710451i,-0.297499261243923 + 0.221455459483545i,-0.883518546798752 - 1.19672956422488i,0.561806137522460 + 0.216467288910102i;0.946692912991553 - 0.945099332603186i,-1.29519406325250 - 0.277337581114895i,0.211972933847837 - 1.52510921234152i,0.278807829019181 - 0.0308832590702703i;-0.382834332642135 + 1.34979163913673i,-0.0191239224983253 + 0.156483609196457i,1.16843875919754 - 0.473086619496272i,0.805673235581551 - 0.0332721833786240i;-0.803594929573665 - 1.86165724852774i,-0.383183235866079 - 1.32265121629082i,-1.00647413695029 + 0.518273956232617i,1.01367595675885 - 0.0330273086283559i;0.427258132158432 + 0.672117697149410i,0.736775510116126 - 0.704108346749836i,-0.846734154343746 - 0.0316868776183985i,0.567608004091173 + 1.43952279760397i;-0.758400852904724 + 1.78677305430078i,-1.32625430473196 - 1.24868706360576i,-0.442104611158330 + 0.296798255809032i,-1.07139353021142 - 1.31106756417464i;0.569735547970959 + 0.623642984190409i,-1.13085394450180 - 0.696203343764398i,-1.09868307277155 - 1.23279164642182i,0.484796143889991 - 1.34167212847700i;-0.523991205954174 + 0.810415325145879i,-0.842839812049374 - 1.43734906389756i,-1.12094317414856 + 1.37879571951612i,0.946859296022977 + 1.13527382393981i;-0.433022295044208 - 0.168059800603948i,0.851280944109568 + 1.52484447111806i,0.420654884733859 + 1.65065590582213i,1.00883838607417 - 1.21869376714555i;1.33305751059669 + 0.748030467642946i,-0.605855867669232 - 0.0193255949457614i,-0.868557677849966 - 1.82013621617417i,-0.0182872213026375 - 0.836869840741023i;0.722097844295578 - 0.255560681732323i,-0.138326444964360 - 1.67994125344927i,-0.236702288668989 - 1.40076498410912i,-0.159061158191065 - 0.834182828855330i;0.969877954349228 - 1.89210679005816i,0.286926844479357 + 1.45384257939191i,-1.06984157474477 + 1.96188332553137i,-0.875090008519871 + 0.623567393863773i;-0.381075031155748 + 0.101006550265343i,-0.186382465518343 + 0.435894229679498i,0.0982383190580664 + 0.698680724427959i,-0.607301189500510 - 1.64969591654203i;1.31796849061029 - 1.08633553357064i,-1.21982133179730 + 1.54020870233248i,-0.689152026368937 - 1.83901148032567i,1.13998405467491 - 1.02749806411302i;0.377147482124779 + 0.884411207768761i,-1.02054879863658 - 1.52112604686332i,-1.25119741377670 - 1.57864083586825i,-1.09797793621809 - 0.00690540444633525i;-0.514622609553684 + 1.78016078466252i,-1.37667235434429 + 0.402243606945027i,0.858531003673886 + 1.28521293955176i,-1.32229745477378 - 1.94953455156482i;1.07459695954813 + 1.72930032852840i,0.947569181676544 + 1.50644297113688i,0.708466764979174 + 1.31628926621697i,0.445539360270829 - 0.598764966142612i;-0.450289411171574 + 0.260805394585961i,1.34615359081055 - 0.0256324401527257i,1.29262081455011 + 1.07539965152521i,-0.737012717336016 + 1.73320856014929i;-0.775619895055635 + 1.63128339422509i,1.41085428225557 + 1.11924625073950i,0.826813204069822 + 1.70035771513008i,0.998764006372753 + 0.270582662759272i];
N = pkt_num ;
M = ant_num ;
% global CSI;
global master_length;
global pkt;

used_pkt= [];

spare_signal_strength_list = zeros(M,M);  %record SNR-based spared packets of each stream

orthogonal_set = zeros(N, M);
quantize_set = ones(1, N );
    for i = 1 : N
        orthogonal_set(i,M) = i;
        CSI_per_user = CSI(i,:);
        CSI_per_user_direction = CSI_per_user/norm(CSI_per_user);
        orthogonal__directions = null(CSI_per_user_direction);
        CSI_vectors = [orthogonal__directions,CSI_per_user_direction']; % orthogonol vectors for ith user

        inner_products = (abs (CSI*CSI_vectors) ).^2;
        norms_CSI = (diag (CSI*CSI') );
        norms_vectors = (diag (CSI_vectors'*CSI_vectors) );
        norms = norms_CSI* norms_vectors';
        metric_proximty_per_user(i,:,:) = inner_products./norms;
        %-------------find M-1 most orthogonal users with ith user
        for j = 1 : M-1
            orthogonal_set(i, j) = find(metric_proximty_per_user(i,:,j) == max(metric_proximty_per_user(i,:,j)), 1 );
            quantize_set(i) = quantize_set(i) + max(metric_proximty_per_user(i,:,j));
        end
    end
    
    max_index  = find( quantize_set == max(quantize_set), 1 );
    
    selected_index_list = orthogonal_set(max_index,:);
    %  calculate SNR-based spared packets of each stream
    i = selected_index_list(M);
    for j = 1:M    
        sorted_strength = sort(metric_proximty_per_user(i,:,j));
        if j == M
            sorted_strength = sorted_strength(N-M-1:N-1);
        else
            sorted_strength = sorted_strength(N-M:N);
        end
        for ii = 1:M
            sorted_signal_strength_list(j,ii) = find(metric_proximty_per_user(i,:,j) == sorted_strength(ii) , 1);
            metric_proximty_per_user(find(metric_proximty_per_user(i,:,j) == sorted_strength(ii) , 1)) = -1;
        end
    end
    
    
    
%---------set master length  
max_length = 0;
for p = 1: M
    if max_length < pkt(selected_index_list(p)).length
        max_length = pkt(selected_index_list(p)).length;
    end
end  
master_length = max_length;   